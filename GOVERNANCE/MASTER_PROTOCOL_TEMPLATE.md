# MASTER_PROTOCOL_TEMPLATE.md
## Spec & Test Driven Iteration（Generic）

Version: 1.0.1  
LastUpdated: YYYY-MM-DD  

---

## 0. 目的と適用範囲

本ドキュメントは、LLM（設計AI・実装AI）を用いた開発において、

- 推測を排除し
- 仕様駆動・テスト先行を強制し
- 反復のたびに設計資産を蓄積する

ための **最上位プロトコル（憲法）**である。

本プロトコルは、個別プロジェクト（BUYMA、自律型エージェント等）に依存しない。  
プロジェクト固有の前提条件は **Phase 0** にて定義する。

---

## -1. Global Rules（横断ルール／最重要）

### -1.1 Gate（参照強制）

以下が提示・確認できない場合、**Phase 1 以降を開始してはならない**。

- ARCHITECTURE.md（最新版：[ARCHITECTURES/](./ARCHITECTURES/) への入口）
- PROJECT_PROFILES/PROJECT_PROFILE_<PROJECT_KEY>.md（Phase 0 の成果物）

不足時は、**提示を要求して停止**すること。

**禁止事項**
- 記憶・推測・暗黙補完による設計
- 「おそらく」「一般的には」に基づく判断

---

### -1.2 版確認（最新版保証）

ARCHITECTURE.md および参照先の詳細設計図には以下が含まれていることを前提とする。

- Version
- LastUpdated
- Commit Hash（可能な場合）

不明な場合は確認を要求する。

---

### -1.3 出力順序（固定）

開発タスクの出力は、原則として以下の順序に固定する。

1. 仕様定義  
2. テストコード／テストケース  
   - 保存先パス  
   - 実行ディレクトリ（cwd）  
   - 実行コマンド  
3. 実装担当AIへの指示プロンプト案  
   - **全文コピペ前提**  
4. （必要時のみ）ARCHITECTURE_<PROJECT_KEY>.md 更新案  
   - **diff形式を推奨**  
5. Decision Log（必須）

---

### -1.4 Definition of Done（DoD）

以下をすべて満たして初めて完了とする。

- すべてのテストが Pass（Green）
- 既存テストが退行していない
- 異常系・境界条件が仕様通り定義されている
- 変更が設計図に反映されている（該当時）

---

### -1.5 セキュリティ例外規定

原則として実装コードは提示しない。

ただし、**セキュリティ診断（OWASP Top 10、Red Team 視点）**の指示があった場合のみ、

- 最小限の修正パッチ（diff形式）に限り提示を許可する
- 機能改善・リファクタ提案は禁止する

---

## Phase 0: Project Specialization（必須）

### 目的

プロジェクト固有の前提条件を固定し、  
以降の仕様策定・設計判断のブレを防ぐ。

### 成果物

- `PROJECT_PROFILES/PROJECT_PROFILE_<PROJECT_KEY>.md`
  - PROJECT_KEY は **英大文字の短縮識別子**とする  
    （例：BUYMA / NEXUSCORE）

### 必須項目（概要）

- プロジェクト名
- 目的／対象範囲
- 技術スタック
- 変更禁止事項／変更許可事項
- セキュリティ基準
- 性能・コストの優先度
- 規約・ポリシー制約

**未記入・未確定の場合、Phase 1 に進んではならない。**

---

## Phase 1: Spec & Test Definition

### 目的

実装前に「何を作るか」と「成功条件」を明確に確定させる。

### 必須出力

1. **詳細仕様書**
   - 要件定義
   - 制約条件
   - インターフェース定義
   - 例外時の挙動
   - 変更許可範囲／禁止事項

2. **テストコード／テストケース**
   - 正常系
   - 異常系
   - 境界値
   -（可能なら）回帰テスト
   - 実行ディレクトリ（cwd）
   - 実行コマンド

**この Phase では、実装コードを出力してはならない。**

---

## Phase 2: Implementation

### 目的

Phase 1 で確定した仕様とテストを満たす実装を、  
実装担当AIに委譲する。

### ルール

- 仕様外の機能追加は禁止
- 依存関係の追加は事前承認制
- テストを Pass させることが唯一の完了条件

---

## Phase 2.5: Independent Review Gate（必須）

### 目的

実装が完了し、テストを Pass した成果物を、**開発時とは完全に関係のない「独立した AI コンテキスト（別セッション）」**にて客観的に検証する。

### ルール（強制）

- **別コンテキスト強制**: 開発を行ったチャットセッションや IDE 内の AI ではなく、新規の ChatGPT/Claude 等で実行すること。
- **IDE 内自己チェックは無効**: カーソルや IDE 統合の AI による自己チェックは Phase 2.5 に該当しない。
- **指示方法**: `GOVERNANCE/REVIEW_PACKET_TEMPLATE.md` を使用して、仕様書と実装内容（diff）を提示する。
- **レビュアーの禁止事項**: 修正コードの提示は禁止。判定（Approve/Reject）と根拠のみを出力させる。

### 成果物

- **Decision Log**: レビュー結果（Verdict, Rationale, Findings）を `DECISION_LOGS/` に転記する。

---

### 実施条件

明示的に指示があった場合のみ実施する。

### 視点／基準

- 攻撃者視点（Red Team）
- OWASP Top 10

### 出力

- 脆弱性内容
- 影響
- 修正方針
- 最小限の修正パッチ（diff）

---

## Phase 4: Merge & Assetization

### 目的

成果物を統合し、  
次回以降に再利用可能な **設計資産**として残す。

### 必須作業

- 実装結果の評価
- ARCHITECTURE_<PROJECT_KEY>.md 更新（該当時）
- Decision Log (DECISION_LOGS/) の作成

### Decision Log（必須）

- 何を決めたか
- なぜそうしたか
- **影響範囲（影響するファイル／モジュール）**
- 却下した代替案
- 次回へのルール（再発防止）

---

## 付記：基本姿勢

- 推測で進めない
- Green でも疑う
- 判断は必ず言語化する
- 不明点は「不明」と明示し、情報提示を要求する

---

## 本プロトコルの位置づけ

本ドキュメントは、

- 個別プロジェクトより上位
- ARCHITECTURE.md および参照先の詳細設計図より上位
- すべての開発タスクに優先

される **不変ルール**である。
